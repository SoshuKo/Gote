<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„Åî„Å¶„Åî„Å¶ - „Å∑„Çà„Å∑„ÇàÈ¢®„Éë„Ç∫„É´</title>
  <style>
    * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fdfbfb, #ebedee);
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      padding: 16px 20px 20px;
      max-width: 960px;
      width: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.6rem;
    }

    header small {
      opacity: 0.7;
      font-size: 0.8rem;
    }

    nav {
      display: flex;
      gap: 8px;
    }

    .tab-btn {
      border: none;
      padding: 6px 14px;
      border-radius: 999px;
      background: #f0f0f5;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, transform 0.1s;
    }

    .tab-btn span.icon {
      font-size: 1.1rem;
    }

    .tab-btn.active {
      background: linear-gradient(120deg, #6c5ce7, #a55eea);
      color: #fff;
    }

    .tab-btn:active {
      transform: translateY(1px);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr);
      gap: 20px;
    }

    section {
      border-radius: 14px;
      background: #fafbff;
      padding: 12px 14px 14px;
      position: relative;
      overflow: hidden;
    }

    section h2 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    section h2 span.label-sub {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    #gote-select-screen { display: none; }
    #gote-select-screen.active { display: block; }

    #game-screen { display: block; }
    #game-screen.hidden { display: none; }

    /* Game area */
    #game-wrapper {
      display: flex;
      gap: 10px;
    }

    #board-container {
      position: relative;
      padding: 8px;
      border-radius: 12px;
      background: linear-gradient(145deg, #cfd9df, #e2ebf0);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5);
    }

    #board {
      width: 240px; /* 6 * 40 */
      height: 480px; /* 12 * 40 */
      background: #1e272e;
      border-radius: 8px;
      padding: 4px;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(12, 1fr);
      gap: 2px;
      position: relative;
      overflow: hidden;
    }

    .cell {
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      position: relative;
    }

    .gote {
      position: absolute;
      inset: 2px;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      --gote-color: #ff4b5c;
    }

    .gote-inner {
      width: 90%;
      height: 90%;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.9), var(--gote-color));
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.6),
        0 4px 10px rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .gote-inner img {
      max-width: 95%;
      max-height: 95%;
      image-rendering: pixelated;
    }

    .gote.clearing .gote-inner {
      animation: gote-pop 450ms ease-out forwards;
    }

    @keyframes gote-pop {
      0% { transform: scale(1) rotate(0deg); opacity: 1; }
      25% { transform: scale(1.15) rotate(-6deg); }
      50% { transform: scale(0.95) rotate(6deg); }
      100% { transform: scale(0); opacity: 0; }
    }

    #info-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .info-box {
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
    }

    .info-row:last-child { margin-bottom: 0; }

    #next-preview {
      display: grid;
      grid-template-columns: repeat(2, 30px);
      grid-template-rows: repeat(2, 30px);
      gap: 2px;
      margin-top: 4px;
    }

    #next-preview .preview-cell {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      background: #1e272e;
      position: relative;
    }

    .preview-gote {
      --gote-color: #ff4b5c;
      position: absolute;
      inset: 2px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .preview-gote-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.9), var(--gote-color));
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .preview-gote-inner img {
      max-width: 95%;
      max-height: 95%;
      image-rendering: pixelated;
    }

    #controls-list {
      font-size: 0.8rem;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* „Çø„ÉÉ„ÉÅÊìç‰Ωú„Éú„Çø„É≥ */
    #touch-controls {
      display: none;
    }

    .touch-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.85rem;
      background: #f0f0f5;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      min-width: 64px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
    }

    .touch-btn span.icon {
      font-size: 1.1rem;
    }

    .touch-btn:active {
      transform: translateY(1px);
    }

    #game-over-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 10;
      text-align: center;
    }

    #game-over-overlay.active {
      display: flex;
    }

    #game-over-overlay button {
      margin-top: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: #ff7675;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* Gote select screen */
    #gote-select-layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.9rem;
    }

    .slot-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 10px;
    }

    .slot-label {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .slot-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slot-preview {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .slot-preview-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.9), var(--gote-color));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slot-preview-inner img {
      max-width: 90%;
      max-height: 90%;
      image-rendering: pixelated;
    }

    .slot-config {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 100%;
    }

    .slot-config-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .slot-config-row label {
      font-size: 0.75rem;
      opacity: 0.8;
      white-space: nowrap;
    }

    select, input[type="color"] {
      font-size: 0.8rem;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid #dcdde1;
      background: #fff;
    }

    #apply-config {
      align-self: flex-end;
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(120deg, #6c5ce7, #a55eea);
      color: #fff;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 2px;
    }

        @media (max-width: 820px) {
      #app {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
      }
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      #game-wrapper {
        flex-direction: column;
      }
      #touch-controls {
        display: flex;
        margin-top: 10px;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }
    }
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>„Åî„Å¶„Åî„Å¶</h1>
      <small>„Å∑„Çà„Å∑„Çà„ÇÇ„Å©„Åç / Áü¢Âç∞„Ç≠„Éº„ÅßÊìç‰Ωú</small>
    </header>

    <nav>
      <button class="tab-btn active" id="tab-game">
        <span class="icon">üéÆ</span><span>„Ç≤„Éº„É†</span>
      </button>
      <button class="tab-btn" id="tab-select">
        <span class="icon">üß∏</span><span>„Åî„Å¶„Çª„É¨„ÇØ„Éà</span>
      </button>
    </nav>

    <main>
      <section id="game-screen">
        <h2>„Éó„É¨„Ç§ÁîªÈù¢ <span class="label-sub">/ „Åî„Å¶„Åî„Å¶Êú¨Á∑®</span></h2>
        <div id="game-wrapper">
          <div id="board-container">
            <div id="board"></div>
            <div id="game-over-overlay">
              <div>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº‚Ä¶ÔºÅ<br>„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÈÅä„Å∂Ôºü</div>
              <button id="restart-btn">„É™„Çπ„Çø„Éº„Éà</button>
            </div>
          </div>
          <div id="info-panel">
            <div class="info-box">
              <div class="info-row"><span>„Çπ„Ç≥„Ç¢</span><strong id="score">0</strong></div>
              <div class="info-row"><span>„Çå„Çì„Åï</span><strong id="chain">0</strong></div>
            </div>
            <div class="info-box">
              <div>„Å§„Åé„ÅÆ„Åî„Å¶</div>
              <div id="next-preview">
                <div class="preview-cell" data-pos="0"></div>
                <div class="preview-cell" data-pos="1"></div>
                <div class="preview-cell" data-pos="2"></div>
                <div class="preview-cell" data-pos="3"></div>
              </div>
            </div>
            <div class="info-box" id="controls-list">
              <div>‚ñ∂ Êìç‰Ωú</div>
              <div>‚Üê / ‚Üí : ÁßªÂãï</div>
              <div>‚Üì : „ÇΩ„Éï„Éà„Éâ„É≠„ÉÉ„Éó</div>
              <div>Z / ‚Üë : Â∑¶ÂõûËª¢</div>
              <div>X : Âè≥ÂõûËª¢</div>
              <div>„Çπ„Éö„Éº„Çπ : ‰∏ÄÊ∞ó„Å´ËêΩ‰∏ã</div>
            </div>
          </div>
        </div>
        <div id="touch-controls">
          <button class="touch-btn" id="btn-left"><span class="icon">‚¨ÖÔ∏è</span><span>Â∑¶</span></button>
          <button class="touch-btn" id="btn-right"><span class="icon">‚û°Ô∏è</span><span>Âè≥</span></button>
          <button class="touch-btn" id="btn-rot-left"><span class="icon">‚§ø</span><span>ÂõûËª¢L</span></button>
          <button class="touch-btn" id="btn-rot-right"><span class="icon">‚§æ</span><span>ÂõûËª¢R</span></button>
          <button class="touch-btn" id="btn-down"><span class="icon">‚¨áÔ∏è</span><span>„Åä„Çç„Åô</span></button>
          <button class="touch-btn" id="btn-drop"><span class="icon">üí•</span><span>„ÅÑ„Å£„ÅçËêΩ‰∏ã</span></button>
        </div>
      </section>

      <section id="gote-select-screen">
        <h2>„Åî„Å¶„Çª„É¨„ÇØ„ÉàÁîªÈù¢ <span class="label-sub">/ Ëâ≤ÔºÜ„Ç≠„É£„É©„Ç´„Çπ„Çø„É†</span></h2>
        <div id="gote-select-layout">
          <p style="font-size:0.8rem; opacity:0.8;">4Á®ÆÈ°û„ÅÆ„Åî„Å¶„ÅÆËâ≤„Å®„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂ•Ω„Åç„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇÂ§âÊõ¥„Åô„Çã„Å®Êñ∞„Åó„ÅèËêΩ„Å°„Å¶„Åè„Çã„Åî„Å¶„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</p>

          <div id="slots-container"></div>

          <button id="apply-config">„Åì„ÅÆË®≠ÂÆö„Åß„ÅÇ„Åù„Å∂</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========================
    // „Åî„Å¶ÂÆöÁæ©
    // ========================
    const CHARACTERS = {
      arca: {
        id: 'arca',
        label: '„Ç¢„É´„Ç´',
        defaultColor: '#ff4b5c', // red
        img: '„Ç¢„É´„Ç´.png' // ÁîªÂÉè„Éë„Çπ„ÅØÈÅ©ÂÆúÂ∑Æ„ÅóÊõø„Åà„Å¶„Åè„Å†„Åï„ÅÑ
      },
      killroad: {
        id: 'killroad',
        label: '„Ç≠„É´„É≠„Éº„Éâ',
        defaultColor: '#ffd93b', // yellow
        img: '„Ç≠„É´„É≠„Éº„Éâ.png'
      },
      koto: {
        id: 'koto',
        label: '„Ç≥„Éà',
        defaultColor: '#4b7bec', // blue
        img: '„Ç≥„Éà.png'
      },
      asha: {
        id: 'asha',
        label: '„Ç¢„Éº„Ç∑„É£',
        defaultColor: '#a55eea', // purple
        img: '„Ç¢„Éº„Ç∑„É£.png'
      },
      kyubi: {
        id: 'kyubi',
        label: '„Ç≠„É•„Éì',
        defaultColor: '#1abc9c', // „ÅäÂ•Ω„Åø„Ç´„É©„Éº
        img: '„Ç≠„É•„Éì.png'
      }
    };

    // 4Á®ÆÈ°û„ÅÆ„Åî„Å¶„Çπ„É≠„ÉÉ„ÉàÔºàÁ®ÆÈ°ûÔºâ
    let goteSlots = [
      { slot: 0, charId: 'arca', color: CHARACTERS.arca.defaultColor },
      { slot: 1, charId: 'killroad', color: CHARACTERS.killroad.defaultColor },
      { slot: 2, charId: 'koto', color: CHARACTERS.koto.defaultColor },
      { slot: 3, charId: 'asha', color: CHARACTERS.asha.defaultColor }
    ];

    // ========================
    // ÁîªÈù¢Âàá„ÇäÊõø„Åà
    // ========================
    const tabGame = document.getElementById('tab-game');
    const tabSelect = document.getElementById('tab-select');
    const gameScreen = document.getElementById('game-screen');
    const selectScreen = document.getElementById('gote-select-screen');

    tabGame.addEventListener('click', () => {
      tabGame.classList.add('active');
      tabSelect.classList.remove('active');
      gameScreen.classList.remove('hidden');
      selectScreen.classList.remove('active');
    });

    tabSelect.addEventListener('click', () => {
      tabSelect.classList.add('active');
      tabGame.classList.remove('active');
      gameScreen.classList.add('hidden');
      selectScreen.classList.add('active');
    });

    // ========================
    // „Åî„Å¶„Çª„É¨„ÇØ„ÉàUI
    // ========================
    const slotsContainer = document.getElementById('slots-container');

    function createSlotRow(slotConfig) {
      const row = document.createElement('div');
      row.className = 'slot-row';
      row.dataset.slot = slotConfig.slot;

      const label = document.createElement('div');
      label.className = 'slot-label';
      label.textContent = `„Åî„Å¶ ${slotConfig.slot + 1}`;

      const main = document.createElement('div');
      main.className = 'slot-main';

      const preview = document.createElement('div');
      preview.className = 'slot-preview';
      const previewInner = document.createElement('div');
      previewInner.className = 'slot-preview-inner';
      previewInner.style.setProperty('--gote-color', slotConfig.color);
      const img = document.createElement('img');
      img.alt = '„Åî„Å¶„Éó„É¨„Éì„É•„Éº';
      img.src = CHARACTERS[slotConfig.charId].img;
      previewInner.appendChild(img);
      preview.appendChild(previewInner);

      const config = document.createElement('div');
      config.className = 'slot-config';

      const row1 = document.createElement('div');
      row1.className = 'slot-config-row';
      const charLabel = document.createElement('label');
      charLabel.textContent = '„Ç≠„É£„É©';
      const select = document.createElement('select');
      select.className = 'char-select';
      select.dataset.slot = slotConfig.slot;

      Object.values(CHARACTERS).forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = ch.label;
        if (ch.id === slotConfig.charId) opt.selected = true;
        select.appendChild(opt);
      });

      row1.appendChild(charLabel);
      row1.appendChild(select);

      const row2 = document.createElement('div');
      row2.className = 'slot-config-row';
      const colorLabel = document.createElement('label');
      colorLabel.textContent = '„Ç´„É©„Éº';
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = slotConfig.color;
      colorInput.className = 'color-input';
      colorInput.dataset.slot = slotConfig.slot;

      row2.appendChild(colorLabel);
      row2.appendChild(colorInput);

      config.appendChild(row1);
      config.appendChild(row2);

      main.appendChild(preview);
      main.appendChild(config);

      const miniInfo = document.createElement('div');
      miniInfo.style.fontSize = '0.75rem';
      miniInfo.style.opacity = '0.75';
      miniInfo.textContent = CHARACTERS[slotConfig.charId].label;

      row.appendChild(label);
      row.appendChild(main);
      row.appendChild(miniInfo);

      // „Ç§„Éô„É≥„Éà
      select.addEventListener('change', () => {
        const slot = parseInt(select.dataset.slot, 10);
        const newChar = select.value;
        const slotCfg = goteSlots[slot];
        slotCfg.charId = newChar;
        img.src = CHARACTERS[newChar].img;
        miniInfo.textContent = CHARACTERS[newChar].label;
      });

      colorInput.addEventListener('input', () => {
        const slot = parseInt(colorInput.dataset.slot, 10);
        const c = colorInput.value;
        const slotCfg = goteSlots[slot];
        slotCfg.color = c;
        previewInner.style.setProperty('--gote-color', c);
      });

      return row;
    }

    function buildSlotsUI() {
      slotsContainer.innerHTML = '';
      goteSlots.forEach(slotCfg => {
        const row = createSlotRow(slotCfg);
        slotsContainer.appendChild(row);
      });
    }

    // ========================
    // „Ç≤„Éº„É†Êú¨‰Ωì
    // ========================
    const COLS = 6;
    const ROWS = 12;
    const TICK_MS = 550;

    let board = []; // [y][x] = {slotIndex, charId, color, clearing:false}
    let currentPair = null;
    let nextPair = null;
    let score = 0;
    let chainCount = 0;
    let tickTimer = null;
    let isClearing = false;
    let isGameOver = false;

    const scoreEl = document.getElementById('score');
    const chainEl = document.getElementById('chain');
    const boardEl = document.getElementById('board');
    const gameOverOverlay = document.getElementById('game-over-overlay');
    const restartBtn = document.getElementById('restart-btn');

    function initBoard() {
      board = [];
      for (let y = 0; y < ROWS; y++) {
        const row = [];
        for (let x = 0; x < COLS; x++) {
          row.push(null);
        }
        board.push(row);
      }
    }

    function randomSlotIndex() {
      return Math.floor(Math.random() * goteSlots.length);
    }

    function createRandomGote() {
      const idx = randomSlotIndex();
      const slotCfg = goteSlots[idx];
      const ch = CHARACTERS[slotCfg.charId];
      return {
        slotIndex: idx,
        charId: slotCfg.charId,
        color: slotCfg.color,
        img: ch.img
      };
    }

    function spawnPair() {
      if (!nextPair) {
        nextPair = {
          pivot: createRandomGote(),
          child: createRandomGote()
        };
      }
      currentPair = {
        x: 2,
        y: -1,
        orientation: 2, // Â≠ê„Åå‰∏ã
        pivot: nextPair.pivot,
        child: nextPair.child
      };
      nextPair = {
        pivot: createRandomGote(),
        child: createRandomGote()
      };
      updateNextPreview();
      if (checkCollisionForPair(currentPair.x, currentPair.y, currentPair.orientation)) {
        // ÁΩÆ„ÅèÂâç„Åã„Çâ„Ç¢„Ç¶„Éà
        gameOver();
      }
    }

    function getPairCells(x, y, orientation) {
      const cells = [];
      // pivot
      cells.push({ x, y, part: 'pivot' });
      // child offset
      let dx = 0, dy = 0;
      switch (orientation) {
        case 0: dy = -1; break; // ‰∏ä
        case 1: dx = 1; break;  // Âè≥
        case 2: dy = 1; break;  // ‰∏ã
        case 3: dx = -1; break; // Â∑¶
      }
      cells.push({ x: x + dx, y: y + dy, part: 'child' });
      return cells;
    }

    function checkCollisionForPair(nx, ny, norient) {
      const cells = getPairCells(nx, ny, norient);
      for (const c of cells) {
        if (c.x < 0 || c.x >= COLS || c.y >= ROWS) return true;
        if (c.y >= 0 && board[c.y][c.x]) return true;
      }
      return false;
    }

    function movePair(dx, dy) {
      if (!currentPair || isClearing || isGameOver) return;
      const nx = currentPair.x + dx;
      const ny = currentPair.y + dy;
      if (!checkCollisionForPair(nx, ny, currentPair.orientation)) {
        currentPair.x = nx;
        currentPair.y = ny;
        render();
        return true;
      }
      return false;
    }

    function rotatePair(dir) {
      if (!currentPair || isClearing || isGameOver) return;
      let norient = currentPair.orientation;
      if (dir === 'left') {
        norient = (norient + 3) % 4;
      } else {
        norient = (norient + 1) % 4;
      }
      if (!checkCollisionForPair(currentPair.x, currentPair.y, norient)) {
        currentPair.orientation = norient;
        render();
      }
    }

    function hardDrop() {
      if (!currentPair || isClearing || isGameOver) return;
      while (movePair(0, 1));
      lockPair();
    }

    function lockPair() {
      if (!currentPair) return;
      const cells = getPairCells(currentPair.x, currentPair.y, currentPair.orientation);
      cells.forEach(c => {
        if (c.y < 0) {
          gameOver();
          return;
        }
        const data = c.part === 'pivot' ? currentPair.pivot : currentPair.child;
        if (c.y >= 0) {
          board[c.y][c.x] = {
            slotIndex: data.slotIndex,
            charId: data.charId,
            color: data.color,
            img: data.img,
            clearing: false
          };
        }
      });
      currentPair = null;
      render();
      checkAndClearMatches();
    }

    function tick() {
      if (isClearing || isGameOver) return;
      if (!currentPair) {
        spawnPair();
        render();
        return;
      }
      const moved = movePair(0, 1);
      if (!moved) {
        lockPair();
      }
    }

    function render() {
      // Áõ§Èù¢„Çª„É´
      boardEl.innerHTML = '';
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          const cellEl = document.createElement('div');
          cellEl.className = 'cell';
          cellEl.dataset.x = x;
          cellEl.dataset.y = y;
          boardEl.appendChild(cellEl);
        }
      }

      // „Åî„Å¶ÊèèÁîªÁî®„Éû„ÉÉ„Éó
      const goteMap = {};

      // Âõ∫ÂÆöÊ∏à„Åø
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          const cell = board[y][x];
          if (!cell) continue;
          const key = `${x}-${y}`;
          goteMap[key] = {
            color: cell.color,
            img: cell.img,
            clearing: cell.clearing
          };
        }
      }

      // ËêΩ‰∏ã‰∏≠„Éö„Ç¢
      if (currentPair) {
        const cells = getPairCells(currentPair.x, currentPair.y, currentPair.orientation);
        cells.forEach(c => {
          if (c.y < 0 || c.y >= ROWS) return;
          const data = c.part === 'pivot' ? currentPair.pivot : currentPair.child;
          const key = `${c.x}-${c.y}`;
          goteMap[key] = {
            color: data.color,
            img: data.img,
            clearing: false
          };
        });
      }

      // DOM„Å´ÈÖçÁΩÆ
      const cellElements = boardEl.children;
      for (let i = 0; i < cellElements.length; i++) {
        const cellEl = cellElements[i];
        const x = parseInt(cellEl.dataset.x, 10);
        const y = parseInt(cellEl.dataset.y, 10);
        const key = `${x}-${y}`;
        const g = goteMap[key];
        if (!g) continue;
        const goteEl = document.createElement('div');
        goteEl.className = 'gote';
        if (g.clearing) goteEl.classList.add('clearing');
        goteEl.style.setProperty('--gote-color', g.color);
        const inner = document.createElement('div');
        inner.className = 'gote-inner';
        const img = document.createElement('img');
        img.src = g.img;
        img.alt = '„Åî„Å¶';
        inner.appendChild(img);
        goteEl.appendChild(inner);
        cellEl.appendChild(goteEl);
      }
    }

    // „Éû„ÉÉ„ÉÅÂà§ÂÆö
    function checkAndClearMatches() {
      const visited = [];
      for (let y = 0; y < ROWS; y++) {
        visited[y] = [];
        for (let x = 0; x < COLS; x++) visited[y][x] = false;
      }

      const matches = [];

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          if (visited[y][x]) continue;
          const cell = board[y][x];
          if (!cell) continue;
          const group = [];
          const targetColor = cell.color;
          const stack = [{ x, y }];
          visited[y][x] = true;

          while (stack.length) {
            const { x: cx, y: cy } = stack.pop();
            group.push({ x: cx, y: cy });
            const dirs = [
              { dx: 1, dy: 0 },
              { dx: -1, dy: 0 },
              { dx: 0, dy: 1 },
              { dx: 0, dy: -1 }
            ];
            for (const d of dirs) {
              const nx = cx + d.dx;
              const ny = cy + d.dy;
              if (nx < 0 || nx >= COLS || ny < 0 || ny >= ROWS) continue;
              if (visited[ny][nx]) continue;
              const neighbor = board[ny][nx];
              if (!neighbor) continue;
              if (neighbor.color !== targetColor) continue;
              visited[ny][nx] = true;
              stack.push({ x: nx, y: ny });
            }
          }

          if (group.length >= 4) {
            matches.push(group);
          }
        }
      }

      if (matches.length === 0) {
        chainCount = 0;
        chainEl.textContent = chainCount;
        return;
      }

      // „Éû„ÉÉ„ÉÅ„Åå„ÅÇ„Çã„ÅÆ„ÅßÂèØÊÑõ„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Åó„Å¶„Åã„ÇâÊ∂à„Åô
      isClearing = true;
      chainCount += 1;
      chainEl.textContent = chainCount;
      const gain = matches.reduce((acc, g) => acc + g.length * 10 * chainCount, 0);
      score += gain;
      scoreEl.textContent = score;

      matches.forEach(group => {
        group.forEach(({ x, y }) => {
          if (board[y][x]) board[y][x].clearing = true;
        });
      });

      render();

      setTimeout(() => {
        // ÂÆüÈöõ„Å´Ê∂à„Åô
        matches.forEach(group => {
          group.forEach(({ x, y }) => {
            board[y][x] = null;
          });
        });
        applyGravity();
        isClearing = false;
        render();
        // ÈÄ£Èéñ„ÅåÁ∂ö„Åè„ÅãÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
        checkAndClearMatches();
      }, 500);
    }

    function applyGravity() {
      for (let x = 0; x < COLS; x++) {
        let writeY = ROWS - 1;
        for (let y = ROWS - 1; y >= 0; y--) {
          if (board[y][x]) {
            if (y !== writeY) {
              board[writeY][x] = board[y][x];
              board[y][x] = null;
            }
            writeY--;
          }
        }
      }
    }

    function updateNextPreview() {
      const cells = document.querySelectorAll('#next-preview .preview-cell');
      cells.forEach(c => (c.innerHTML = ''));
      if (!nextPair) return;

      const pieces = [nextPair.pivot, nextPair.child];
      pieces.forEach((piece, index) => {
        const cell = cells[index];
        if (!cell) return;
        const pg = document.createElement('div');
        pg.className = 'preview-gote';
        pg.style.setProperty('--gote-color', piece.color);
        const inner = document.createElement('div');
        inner.className = 'preview-gote-inner';
        const img = document.createElement('img');
        img.src = piece.img;
        img.alt = 'Ê¨°„ÅÆ„Åî„Å¶';
        inner.appendChild(img);
        pg.appendChild(inner);
        cell.appendChild(pg);
      });
    }

    function gameOver() {
      isGameOver = true;
      gameOverOverlay.classList.add('active');
    }

    function restartGame() {
      isGameOver = false;
      gameOverOverlay.classList.remove('active');
      score = 0;
      chainCount = 0;
      scoreEl.textContent = '0';
      chainEl.textContent = '0';
      initBoard();
      currentPair = null;
      nextPair = null;
      isClearing = false;
      spawnPair();
      render();
    }

    restartBtn.addEventListener('click', () => {
      restartGame();
    });

    // „Ç≠„ÉºÊìç‰ΩúÔºà„Ç≠„Éº„Éú„Éº„ÉâÔºâ
    window.addEventListener('keydown', e => {
      if (selectScreen.classList.contains('active')) return; // „Çª„É¨„ÇØ„ÉàÁîªÈù¢‰∏≠„ÅØÊìç‰Ωú„Åó„Å™„ÅÑ
      switch (e.key) {
        case 'ArrowLeft':
        case 'a':
        case 'A':
          movePair(-1, 0);
          break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          movePair(1, 0);
          break;
        case 'ArrowDown':
        case 's':
        case 'S':
          movePair(0, 1);
          break;
        case 'z':
        case 'Z':
        case 'ArrowUp':
          rotatePair('left');
          break;
        case 'x':
        case 'X':
          rotatePair('right');
          break;
        case ' ': // Space
          e.preventDefault();
          hardDrop();
          break;
      }
    });

    // „Çø„ÉÉ„ÉÅÊìç‰ΩúÔºà„Çπ„Éû„ÉõÂêë„ÅëÔºâ
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnRotL = document.getElementById('btn-rot-left');
    const btnRotR = document.getElementById('btn-rot-right');
    const btnDown = document.getElementById('btn-down');
    const btnDrop = document.getElementById('btn-drop');

    function bindTapButton(el, handler) {
      if (!el) return;
      const wrap = (e) => {
        e.preventDefault();
        if (selectScreen.classList.contains('active')) return;
        handler();
      };
      el.addEventListener('click', wrap);
      el.addEventListener('touchstart', wrap, { passive: false });
    }

    bindTapButton(btnLeft, () => movePair(-1, 0));
    bindTapButton(btnRight, () => movePair(1, 0));
    bindTapButton(btnRotL, () => rotatePair('left'));
    bindTapButton(btnRotR, () => rotatePair('right'));
    bindTapButton(btnDown, () => movePair(0, 1));
    bindTapButton(btnDrop, () => hardDrop());

    // Ë®≠ÂÆöÂèçÊò†„Éú„Çø„É≥
    document.getElementById('apply-config').addEventListener('click', () => {
      // „Åô„Åß„Å´ËêΩ„Å°„Å¶„ÅÑ„Çã„Åî„Å¶„ÅØËâ≤„Åù„ÅÆ„Åæ„Åæ„ÄÅ„Åì„Çå‰ª•Èôç„ÅÆ„É©„É≥„ÉÄ„É†ÁîüÊàê„Å´ÂèçÊò†
      tabGame.click();
    });

    // ÂàùÊúüÂåñ
    function init() {
      buildSlotsUI();
      initBoard();
      spawnPair();
      render();
      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(tick, TICK_MS);
    }

    init();
  </script>
</body>
</html>
